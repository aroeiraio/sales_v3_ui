<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoS - Tela de Pagamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="payment_theme.css">
    
    <style>
        /* Success Circle Animation */
        @keyframes successCircle {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            30% {
                transform: scale(2.5);
                opacity: 0.9;
            }
            60% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Failure Circle Animation */
        @keyframes failureCircle {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            30% {
                transform: scale(2.5);
                opacity: 0.9;
            }
            60% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Success Icon Animation */
        @keyframes successIcon {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            60% {
                opacity: 0;
                transform: scale(0);
            }
            80% {
                opacity: 1;
                transform: scale(1.3);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Failure Icon Animation */
        @keyframes failureIcon {
            0% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            60% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            70% {
                opacity: 1;
                transform: scale(1.3) rotate(-10deg);
            }
            80% {
                opacity: 1;
                transform: scale(1.1) rotate(10deg);
            }
            90% {
                opacity: 1;
                transform: scale(1.05) rotate(-5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        /* Processing Animation */
        @keyframes processingPulse {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }
        
        /* Card Float Animation */
        @keyframes cardFloat {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-8px);
            }
        }
        
        /* Shimmer Loading */
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }
        
        .success-circle {
            animation: successCircle 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .failure-circle {
            animation: failureCircle 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .success-icon {
            animation: successIcon 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .failure-icon {
            animation: failureIcon 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .processing-pulse {
            animation: processingPulse 1.5s ease-in-out infinite;
        }
        
        .card-float {
            animation: cardFloat 2s ease-in-out infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Hide/Show States */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* Payment Card Hover Effects */
        .payment-method:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.2);
        }
        
        .payment-method:active {
            transform: translateY(-2px);
        }
        
        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple:active::before {
            width: 300px;
            height: 300px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .amount-display {
                font-size: 1.5rem !important;
            }
            
            .payment-method {
                min-height: 80px;
            }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Main Container -->
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b p-4">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <button onclick="goBack()" class="flex items-center space-x-2 text-gray-600 hover:text-gray-900 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span class="font-medium">Voltar</span>
                </button>
                
                <div class="text-center">
                    <p class="text-sm text-gray-500 mb-1">Total a pagar</p>
                    <p class="amount-display text-gray-900">R$ 125,50</p>
                </div>
                
                <div id="statusIndicator" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-gray-300"></div>
                    <span class="text-sm text-gray-500">Aguardando</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
            
            <!-- Payment Method Selection Screen -->
            <div id="paymentMethodScreen" class="screen active flex-col items-center justify-center space-y-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">Escolha a forma de pagamento</h1>
                    <p class="text-gray-600">Selecione como deseja pagar</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl">
                    <!-- Credit Card -->
                    <button onclick="selectPayment('credit')" class="payment-method payment-card ripple p-8 text-center transition-all duration-300 hover:scale-105">
                        <div class="flex flex-col items-center space-y-4">
                            <i data-lucide="credit-card" class="w-12 h-12 text-blue-600"></i>
                            <h3 class="text-xl font-semibold text-gray-900">Cartão de Crédito</h3>
                            <p class="text-gray-600">Aproxime, insira ou passe o cartão</p>
                        </div>
                    </button>
                    
                    <!-- Debit Card -->
                    <button onclick="selectPayment('debit')" class="payment-method payment-card ripple p-8 text-center transition-all duration-300 hover:scale-105">
                        <div class="flex flex-col items-center space-y-4">
                            <i data-lucide="credit-card" class="w-12 h-12 text-green-600"></i>
                            <h3 class="text-xl font-semibold text-gray-900">Cartão de Débito</h3>
                            <p class="text-gray-600">Aproxime, insira ou passe o cartão</p>
                        </div>
                    </button>
                </div>
                
                <!-- PIX Option -->
                <button onclick="selectPayment('pix')" class="payment-method payment-card ripple p-6 text-center transition-all duration-300 hover:scale-105 w-full max-w-md">
                    <div class="flex items-center justify-center space-x-4">
                        <i data-lucide="smartphone" class="w-8 h-8 text-purple-600"></i>
                        <div class="text-left">
                            <h3 class="text-lg font-semibold text-gray-900">PIX</h3>
                            <p class="text-gray-600">Pagamento instantâneo</p>
                        </div>
                    </div>
                </button>
            </div>
            
            <!-- Wait Screen -->
            <div id="waitScreen" class="screen flex-col items-center justify-center space-y-8">
                <div class="text-center">
                    <div class="processing-pulse mb-6">
                        <i data-lucide="loader-2" class="w-16 h-16 text-blue-600 animate-spin"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Processando...</h2>
                    <p class="text-gray-600 processing-pulse">Aguarde enquanto preparamos seu pagamento</p>
                </div>
            </div>
            
            <!-- Insert/Tap Card Screen -->
            <div id="insertCardScreen" class="screen flex-col items-center justify-center space-y-8">
                <div class="text-center">
                    <div class="card-float mb-6">
                        <i data-lucide="credit-card" class="w-24 h-24 text-blue-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Insira ou Aproxime o Cartão</h2>
                    <p class="text-gray-600">Insira, passe ou aproxime seu cartão no leitor</p>
                </div>
                
                <div class="flex space-x-4 text-sm text-gray-500">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-blue-600 rounded-full animate-pulse"></div>
                        <span>Aguardando cartão...</span>
                    </div>
                </div>
            </div>
            
            <!-- Success Screen -->
            <div id="successScreen" class="screen flex-col items-center justify-center space-y-8">
                <div class="relative">
                    <!-- Success Circle Background -->
                    <div class="w-32 h-32 bg-green-500 rounded-full flex items-center justify-center success-circle">
                        <i data-lucide="check" class="w-16 h-16 text-white success-icon"></i>
                    </div>
                </div>
                
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-green-600 mb-2">Pagamento Aprovado!</h2>
                    <p class="text-gray-600 mb-6">Seu pagamento foi processado com sucesso</p>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="text-left">
                                <p class="text-gray-500">Valor:</p>
                                <p class="font-semibold text-gray-900">R$ 125,50</p>
                            </div>
                            <div class="text-left">
                                <p class="text-gray-500">Forma:</p>
                                <p class="font-semibold text-gray-900" id="paymentMethodUsed">Cartão</p>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="finishTransaction()" class="btn-primary w-full max-w-sm">
                        Finalizar
                    </button>
                </div>
            </div>
            
            <!-- Failure Screen -->
            <div id="failureScreen" class="screen flex-col items-center justify-center space-y-8">
                <div class="relative">
                    <!-- Failure Circle Background -->
                    <div class="w-32 h-32 bg-red-500 rounded-full flex items-center justify-center failure-circle">
                        <i data-lucide="x" class="w-16 h-16 text-white failure-icon"></i>
                    </div>
                </div>
                
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-red-600 mb-2">Pagamento Recusado</h2>
                    <p class="text-gray-600 mb-6">O pagamento não foi aprovado</p>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-red-800">
                            <i data-lucide="alert-circle" class="w-4 h-4 inline mr-2"></i>
                            Verifique os dados do cartão ou tente outro método de pagamento
                        </p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 max-w-sm">
                        <button onclick="retryPayment()" class="btn-primary flex-1">
                            Tentar Novamente
                        </button>
                        <button onclick="goToEnd()" class="btn-secondary flex-1">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- End Screen -->
            <div id="endScreen" class="screen flex-col items-center justify-center space-y-8">
                <div class="text-center">
                    <i data-lucide="home" class="w-16 h-16 text-gray-400 mb-6"></i>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Transação Finalizada</h2>
                    <p class="text-gray-600 mb-6">Obrigado por usar nosso sistema</p>
                    
                    <button onclick="startNewTransaction()" class="btn-primary">
                        Nova Transação
                    </button>
                </div>
            </div>
            
        </main>
        
        <!-- Footer -->
        <footer class="bg-white border-t p-4">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <button onclick="cancelTransaction()" class="text-gray-500 hover:text-red-600 transition-colors">
                    <i data-lucide="x-circle" class="w-5 h-5 inline mr-2"></i>
                    Cancelar
                </button>
                
                <button class="text-gray-500 hover:text-blue-600 transition-colors">
                    <i data-lucide="help-circle" class="w-5 h-5 inline mr-2"></i>
                    Ajuda
                </button>
            </div>
        </footer>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Global state management
        let currentScreen = 'paymentMethodScreen';
        let paymentMethod = '';
        let transactionId = '';
        let pollingInterval;
        
        // Screen management
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show target screen
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            
            // Update status indicator
            updateStatusIndicator();
        }
        
        function updateStatusIndicator() {
            const indicator = document.getElementById('statusIndicator');
            const dot = indicator.querySelector('.w-3');
            const text = indicator.querySelector('span');
            
            switch(currentScreen) {
                case 'paymentMethodScreen':
                    dot.className = 'w-3 h-3 rounded-full bg-gray-300';
                    text.textContent = 'Aguardando';
                    break;
                case 'waitScreen':
                    dot.className = 'w-3 h-3 rounded-full bg-yellow-400 animate-pulse';
                    text.textContent = 'Processando';
                    break;
                case 'insertCardScreen':
                    dot.className = 'w-3 h-3 rounded-full bg-blue-400 animate-pulse';
                    text.textContent = 'Aguardando Cartão';
                    break;
                case 'successScreen':
                    dot.className = 'w-3 h-3 rounded-full bg-green-500';
                    text.textContent = 'Aprovado';
                    break;
                case 'failureScreen':
                    dot.className = 'w-3 h-3 rounded-full bg-red-500';
                    text.textContent = 'Recusado';
                    break;
                default:
                    dot.className = 'w-3 h-3 rounded-full bg-gray-300';
                    text.textContent = 'Aguardando';
            }
        }
        
        // Payment method selection
        function selectPayment(method) {
            paymentMethod = method;
            
            if (method === 'pix') {
                processPix();
            } else {
                processCard(method);
            }
        }
        
        // Process card payment
        async function processCard(method) {
            showScreen('waitScreen');
            
            try {
                const response = await fetch('http://localhost:8090/interface/payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        broker: 'MERCADOPAGO_PINPAD',
                        method: method
                    })
                });
                
                const data = await response.json();
                transactionId = data.transactionId;
                
                // Start polling for status
                startPolling();
                
            } catch (error) {
                console.error('Payment error:', error);
                setTimeout(() => showScreen('failureScreen'), 1000);
            }
        }
        
        // Process PIX payment
        async function processPix() {
            showScreen('waitScreen');
            
            try {
                const response = await fetch('http://localhost:8090/interface/payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        broker: 'MERCADOPAGO',
                        method: 'mercadopago'
                    })
                });
                
                const data = await response.json();
                transactionId = data.transactionId;
                
                // Start polling for status
                startPolling();
                
            } catch (error) {
                console.error('PIX payment error:', error);
                setTimeout(() => showScreen('failureScreen'), 1000);
            }
        }
        
        // Status polling
        function startPolling() {
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('http://localhost:8090/interface/payment/status');
                    const status = await response.json();
                    
                    handleStatusUpdate(status);
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollingInterval);
                    showScreen('failureScreen');
                }
            }, 1000);
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        // Handle status updates from API
        function handleStatusUpdate(status) {
            switch(status.message) {
                case 'WAIT':
                    showScreen('waitScreen');
                    break;
                    
                case 'INSERT_TAP_CARD':
                    showScreen('insertCardScreen');
                    break;
                    
                case 'RELEASE':
                    if (status.paymentStatus === 'PAYMENT_APPROVED') {
                        stopPolling();
                        document.getElementById('paymentMethodUsed').textContent = 
                            paymentMethod === 'credit' ? 'Cartão de Crédito' :
                            paymentMethod === 'debit' ? 'Cartão de Débito' : 'PIX';
                        showScreen('successScreen');
                    }
                    break;
                    
                case 'SHOW_RETRY':
                    if (status.paymentStatus === 'PAYMENT_REFUSED') {
                        stopPolling();
                        showScreen('failureScreen');
                    }
                    break;
            }
        }
        
        // Navigation functions
        function goBack() {
            if (currentScreen === 'paymentMethodScreen') {
                // Go back to previous screen (checkout)
                window.history.back();
            } else {
                stopPolling();
                showScreen('paymentMethodScreen');
            }
        }
        
        function retryPayment() {
            showScreen('paymentMethodScreen');
        }
        
        function goToEnd() {
            showScreen('endScreen');
        }
        
        function finishTransaction() {
            showScreen('endScreen');
        }
        
        function startNewTransaction() {
            paymentMethod = '';
            transactionId = '';
            showScreen('paymentMethodScreen');
        }
        
        function cancelTransaction() {
            if (confirm('Tem certeza que deseja cancelar a transação?')) {
                stopPolling();
                window.history.back();
            }
        }
        
        // Demo mode for testing animations
        function demoSuccess() {
            showScreen('successScreen');
        }
        
        function demoFailure() {
            showScreen('failureScreen');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            showScreen('paymentMethodScreen');
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });
    </script>
</body>
</html>